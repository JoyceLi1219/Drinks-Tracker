<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 手搖紀錄器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #D4EBF8;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .custom-dashed-border {
            border: 3px dashed rgba(169, 214, 241, 0.6);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // 使用原生 React.createElement 的簡寫，避免 Babel 編譯錯誤
        const h = React.createElement;
        const { useState, useEffect, useMemo } = React;

        // 圖示組件：直接操作 DOM 確保 100% 渲染
        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = React.useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    ref.current.innerHTML = '';
                    const icon = window.lucide.icons[name];
                    if (icon) {
                        const svg = icon.toSvg({
                            width: size,
                            height: size,
                            class: className,
                            'stroke-width': 2
                        });
                        ref.current.innerHTML = svg;
                    }
                }
            }, [name, size, className]);
            return h('span', { ref, className: `inline-flex items-center justify-center ${className}` });
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('daily');
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(new Date(2026, 0, 1).toDateString());
            const [records, setRecords] = useState(() => {
                try {
                    const saved = localStorage.getItem('drink_records_2026');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });
            const [editingDraft, setEditingDraft] = useState(null);

            const iceOptions = ["固定", "正常", "少冰", "微冰", "去冰", "常溫", "溫"];
            const sugarOptions = ["固定", "全糖", "少糖", "半糖", "微糖", "微微糖", "一分糖", "無糖"];

            useEffect(() => {
                localStorage.setItem('drink_records_2026', JSON.stringify(records));
            }, [records]);

            const stats = useMemo(() => {
                let monthlyCount = 0, monthlySpend = 0, yearlyCount = 0, yearlySpend = 0;
                const shopFreq = {}, itemFreq = {};
                const monthlyData = Array.from({ length: 12 }, () => ({ count: 0, spend: 0 }));
                const targetMonth = currentDate.getMonth();

                Object.entries(records).forEach(([dateStr, dayRecords]) => {
                    const d = new Date(dateStr);
                    if (d.getFullYear() === 2026) {
                        const count = dayRecords.length;
                        const spend = dayRecords.reduce((sum, r) => sum + (Number(r.price) || 0), 0);
                        const mIdx = d.getMonth();
                        yearlyCount += count;
                        yearlySpend += spend;
                        if (monthlyData[mIdx]) {
                            monthlyData[mIdx].count += count;
                            monthlyData[mIdx].spend += spend;
                        }
                        if (mIdx === targetMonth) {
                            monthlyCount += count;
                            monthlySpend += spend;
                        }
                        dayRecords.forEach(r => {
                            if (r.shop) shopFreq[r.shop] = (shopFreq[r.shop] || 0) + 1;
                            if (r.item) itemFreq[r.item] = (itemFreq[r.item] || 0) + 1;
                        });
                    }
                });
                return { monthlyCount, monthlySpend, yearlyCount, yearlySpend, 
                         topShop: Object.entries(shopFreq).sort((a,b)=>b[1]-a[1])[0]?.[0] || "無",
                         topItem: Object.entries(itemFreq).sort((a,b)=>b[1]-a[1])[0]?.[0] || "無",
                         monthlyData };
            }, [records, currentDate]);

            const monthDays = useMemo(() => {
                const y = currentDate.getFullYear(), m = currentDate.getMonth();
                const total = new Date(y, m + 1, 0).getDate();
                const start = new Date(y, m, 1).getDay();
                const res = [];
                for(let i=0; i<start; i++) res.push(null);
                for(let i=1; i<=total; i++) res.push(new Date(y, m, i));
                return res;
            }, [currentDate]);

            // 渲染邏輯改用 h(...) 確保不依賴 Babel
            return h('div', { className: "min-h-screen p-4 md:p-8 flex items-start justify-center" },
                h('div', { className: "w-full max-w-5xl bg-white rounded-[40px] shadow-2xl overflow-hidden border-2 border-white relative mt-4" },
                    h('div', { className: "absolute inset-2 custom-dashed-border rounded-[34px] pointer-events-none z-0" }),
                    h('div', { className: "relative z-10" },
                        // Header
                        h('header', { className: "p-8 text-center border-b border-slate-100", style: { backgroundColor: '#FEEFAD' } },
                            h('h1', { className: "text-2xl md:text-3xl font-black flex items-center justify-center gap-3" },
                                h('div', { className: "p-2 bg-white rounded-2xl shadow-sm" }, h(Icon, { name: "Coffee", className: "text-blue-500" })),
                                "2026 的我喝了多少手搖"
                            ),
                            h('div', { className: "flex justify-center mt-6" },
                                h('div', { className: "bg-white p-1.5 rounded-2xl flex gap-1 shadow-sm border border-yellow-200/50" },
                                    h('button', { 
                                        onClick: () => setActiveTab('daily'),
                                        className: `flex items-center gap-2 px-6 py-2 rounded-xl text-sm font-black transition-all ${activeTab === 'daily' ? 'bg-blue-500 text-white shadow-md' : 'text-blue-400'}`
                                    }, h(Icon, { name: "Calendar", size: 16 }), "日常紀錄"),
                                    h('button', { 
                                        onClick: () => setActiveTab('stats'),
                                        className: `flex items-center gap-2 px-6 py-2 rounded-xl text-sm font-black transition-all ${activeTab === 'stats' ? 'bg-blue-500 text-white shadow-md' : 'text-blue-400'}`
                                    }, h(Icon, { name: "PieChart", size: 16 }), "統計分析")
                                )
                            )
                        ),
                        // Content
                        activeTab === 'daily' ? h('div', { className: "flex flex-col lg:flex-row" },
                            // Left: Calendar
                            h('div', { className: "w-full lg:w-1/2 p-6 md:p-8 lg:border-r border-slate-100 bg-white" },
                                h('div', { className: "flex items-center justify-between mb-8" },
                                    h('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1)), className: "p-3 bg-slate-50 rounded-2xl" }, h(Icon, { name: "ChevronLeft" })),
                                    h('h2', { className: "text-xl font-black" }, `${currentDate.getFullYear()} 年 ${currentDate.getMonth()+1} 月`),
                                    h('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1)), className: "p-3 bg-slate-50 rounded-2xl" }, h(Icon, { name: "ChevronRight" }))
                                ),
                                h('div', { className: "grid grid-cols-7 gap-2" },
                                    monthDays.map((d, i) => d ? h('button', {
                                        key: i,
                                        onClick: () => { setSelectedDate(d.toDateString()); setEditingDraft(null); },
                                        className: `aspect-square rounded-xl flex items-center justify-center text-sm font-black transition-all ${selectedDate === d.toDateString() ? 'bg-blue-500 text-white scale-110 shadow-lg' : (records[d.toDateString()]?.length ? 'bg-blue-100 text-blue-600' : 'bg-slate-50')}`
                                    }, d.getDate()) : h('div', { key: i }))
                                )
                            ),
                            // Right: Records
                            h('div', { className: "w-full lg:w-1/2 p-6 md:p-8 bg-slate-50/30" },
                                h('div', { className: "flex justify-between items-center mb-6" },
                                    h('h3', { className: "text-lg font-black" }, new Date(selectedDate).toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' })),
                                    !editingDraft && h('button', { 
                                        onClick: () => setEditingDraft({ id: Date.now(), shop: "", item: "", ice: "正常", sugar: "半糖", price: "" }),
                                        className: "bg-blue-500 text-white px-5 py-2 rounded-xl font-black"
                                    }, "新增")
                                ),
                                editingDraft && h('div', { className: "bg-white p-6 rounded-[32px] shadow-xl border-2 border-blue-100 mb-6" },
                                    h('input', { placeholder: "店家", className: "w-full bg-slate-50 rounded-xl p-3 mb-3", onChange: e => setEditingDraft({...editingDraft, shop: e.target.value}) }),
                                    h('input', { placeholder: "品項", className: "w-full bg-slate-50 rounded-xl p-3 mb-3", onChange: e => setEditingDraft({...editingDraft, item: e.target.value}) }),
                                    h('input', { type: "number", placeholder: "金額", className: "w-full bg-slate-50 rounded-xl p-3 mb-4", onChange: e => setEditingDraft({...editingDraft, price: e.target.value}) }),
                                    h('button', { 
                                        onClick: () => {
                                            if(!editingDraft.shop || !editingDraft.item) return;
                                            setRecords({...records, [selectedDate]: [...(records[selectedDate]||[]), editingDraft]});
                                            setEditingDraft(null);
                                        },
                                        className: "w-full bg-blue-500 text-white py-3 rounded-xl font-black"
                                    }, "儲存")
                                ),
                                h('div', { className: "space-y-4" },
                                    (records[selectedDate] || []).map(r => h('div', { key: r.id, className: "bg-white p-5 rounded-[28px] border border-slate-100 flex justify-between items-center" },
                                        h('div', null,
                                            h('p', { className: "text-[10px] text-blue-300 font-black" }, r.shop),
                                            h('p', { className: "text-lg font-black text-slate-700" }, r.item),
                                            h('p', { className: "text-[9px] text-slate-400" }, `${r.ice} / ${r.sugar}`)
                                        ),
                                        h('div', { className: "text-right" },
                                            h('p', { className: "text-xl font-black text-blue-500" }, `$${r.price}`),
                                            h('button', { onClick: () => setRecords({...records, [selectedDate]: records[selectedDate].filter(x=>x.id!==r.id)}), className: "text-slate-200 hover:text-red-400" }, h(Icon, { name: "Trash2", size: 14 }))
                                        )
                                    ))
                                )
                            )
                        ) : h('div', { className: "p-8 space-y-8" },
                            h('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                                h('div', { className: "bg-blue-50 p-6 rounded-3xl" }, h('p', { className: "text-sm font-bold" }, "本月總計"), h('p', { className: "text-3xl font-black" }, `${stats.monthlyCount} 杯 / $${stats.monthlySpend}`)),
                                h('div', { className: "bg-green-50 p-6 rounded-3xl" }, h('p', { className: "text-sm font-bold" }, "年度累計"), h('p', { className: "text-3xl font-black" }, `${stats.yearlyCount} 杯 / $${stats.yearlySpend}`))
                            ),
                            h('div', { className: "p-8 bg-slate-50 rounded-[40px] text-center" },
                                h('p', { className: "text-slate-400 font-bold" }, "最常喝的品項"),
                                h('p', { className: "text-2xl font-black text-blue-500" }, stats.topItem)
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>
</html>
